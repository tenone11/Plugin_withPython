# -*- coding: UTF-8 -*-
import unreal, re, os, sys
sys.path.append('c:\\EGC_Plugins')
import EGC_configs
# update info
reload(EGC_configs)
fbxPath = EGC_configs.maxExportedFile

maxFileName = []
for x in fbxPath:
    (_FilePath,Filename) = os.path.split(x)
    maxFileName.append(Filename)
# ['Box001.FBX', 'Sphere001.FBX']

#import task define to FBX
def staticmesh_for_import_task_option():
    options = unreal.FbxImportUI()
    options.import_mesh = True
    options.import_textures = False
    options.import_materials = False
    options.import_as_skeletal = False
    options.mesh_type_to_import = unreal.FBXImportType.FBXIT_STATIC_MESH
    nomral_method = unreal.FBXNormalImportMethod.FBXNIM_COMPUTE_NORMALS
    options.static_mesh_import_data.normal_import_method = nomral_method
    options.static_mesh_import_data.auto_generate_collision = False
    return options

#export task define to FBX
def staticmesh_for_export_task_option():
    options = unreal.FbxExportOption()
    options.ascii = False
    options.collision = False
    options.level_of_detail = False
    options.map_skeletal_motion_to_root = False
    options.vertex_color = False
    options.export_preview_mesh = False
    options.force_front_x_axis = False
    return options

def EGC_imex_feature(SingleFBX):
    import_task = unreal.AssetImportTask()
    import_task.automated = True
    import_task.replace_existing = True
    import_task.filename = SingleFBX
    import_task.destination_path = '/Game/EGC_Bake'
    import_task.options = staticmesh_for_import_task_option()
    unreal.AssetToolsHelpers.get_asset_tools().import_asset_tasks([import_task])
    # AssetsReady = unreal.EditorAssetLibrary.list_assets(import_task.destination_path, recursive=True, include_folder=False)
    # print AssetsReady     >>>     ["/Game/EGC_Bake/abc3.abc3"]

    export_FBXtask = unreal.AssetExportTask()
    export_FBXtask.automated = True
    export_FBXtask.filename = SingleFBX
    (_FilePath, Filename) = os.path.split(SingleFBX)
    Enginename ='%s.%s'%(Filename.split('.')[0], Filename.split('.')[0])
    #
    export_FBXtask.object = unreal.load_asset(import_task.destination_path + '/'+ Enginename)
    export_FBXtask.options = staticmesh_for_export_task_option()
    # print export_task     >>obj : AssetExportTask

    final = unreal.ExporterFBX.run_asset_export_task(export_FBXtask)
    return final

configini = "c:\\EGC_Plugins\\EGC_configs.py"

def Monitor_ini():
    if os.path.isfile(configini) == True:
        if EGC_configs.MaxToUnreal == True:
            for i in fbxPath:
                EGC_imex_feature(i)
            out_file = open(configini, 'w')
            out_file.write('MaxToUnreal = False')
            out_file.write('\nUnrealExport = True')
            out_file.write('\nmaxExportedFile = None')
            out_file.close()
        else:
            print "no FBX from MAX currently"

if __name__ == "__main__":
    Monitor_ini()

